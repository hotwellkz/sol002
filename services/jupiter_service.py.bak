import aiohttp
import base58
import base64
import asyncio
import os
from solana.rpc.async_api import AsyncClient
from solana.keypair import Keypair
from solana.rpc.types import TxOpts
from solana.transaction import Transaction
from loguru import logger
from typing import Dict, Any, Optional, Union
from solders.rpc.responses import SendTransactionResp
from solana.rpc.commitment import Commitment
from solders.signature import Signature
from services.utils import decrypt_private_key
from services.solana_client import solana_client, send_transaction_with_retry, confirm_transaction_with_retry
import requests
import httpx
from solana.exceptions import SolanaRpcException
from solana.publickey import PublicKey
from config import (
    SOLANA_RPC_URL,
    JUPITER_API_URL,
    JUPITER_API_KEY,
    JUPITER_PLATFORM_FEE_BPS,
    JUPITER_PLATFORM_FEE_ACCOUNT,
    SOLANA_TOKEN_ADDRESSES
)

class JupiterService:
    """
    –°–µ—Ä–≤–∏—Å –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å Jupiter API –¥–ª—è —Å–æ–≤–µ—Ä—à–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π –æ–±–º–µ–Ω–∞ —Ç–æ–∫–µ–Ω–æ–≤ Solana.
    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:
    - –ü–æ–∫—É–ø–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤ –∑–∞ SOL (SOL ‚Üí –¢–æ–∫–µ–Ω)
    - –ü—Ä–æ–¥–∞–∂–∞ —Ç–æ–∫–µ–Ω–æ–≤ –∑–∞ SOL (–¢–æ–∫–µ–Ω ‚Üí SOL)
    - –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ—Ç–∏—Ä–æ–≤–æ–∫ –∏ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤ –æ–±–º–µ–Ω–∞
    """
    def __init__(self):
        self.quote_api_url = f"{JUPITER_API_URL}quote"
        self.swap_api_url = f"{JUPITER_API_URL}swap"
        self.tokens_api_url = f"{JUPITER_API_URL}tokens"
        self.headers = {
            "Authorization": f"Bearer {JUPITER_API_KEY}"
        }
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –µ–¥–∏–Ω—ã–π RPC URL –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        self.solana_client = AsyncClient(SOLANA_RPC_URL, commitment="confirmed")
        logger.info(f"–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω JupiterService —Å API URL: {JUPITER_API_URL}")
        logger.info(f"–ü–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω–∞—è –∫–æ–º–∏—Å—Å–∏—è: {JUPITER_PLATFORM_FEE_BPS} bps ({JUPITER_PLATFORM_FEE_BPS/100}%)")
        logger.info(f"–ö–æ—à–µ–ª–µ–∫ –¥–ª—è –∫–æ–º–∏—Å—Å–∏–∏: {JUPITER_PLATFORM_FEE_ACCOUNT}")

    async def get_all_tokens(self) -> list:
        """
        –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö Jupiter —Ç–æ–∫–µ–Ω–æ–≤
        """
        try:
            async with aiohttp.ClientSession() as session:
                async with session.get(self.tokens_api_url) as response:
                    if response.status != 200:
                        logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤ Jupiter: {response.status}")
                        return []
                    data = await response.json()
                    return data
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤ Jupiter: {str(e)}")
            return []

    async def get_best_route(
        self, 
        input_mint: str, 
        output_mint: str, 
        amount: int, 
        slippage: float = 10.0
    ) -> Dict[str, Any]:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –ª—É—á—à–∏–π –º–∞—Ä—à—Ä—É—Ç –¥–ª—è —Å–≤–æ–ø–∞ —á–µ—Ä–µ–∑ Jupiter API
        
        Args:
            input_mint: –ê–¥—Ä–µ—Å –≤—Ö–æ–¥–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞
            output_mint: –ê–¥—Ä–µ—Å –≤—ã—Ö–æ–¥–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞
            amount: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è —Å–≤–æ–ø–∞ (–≤ –Ω–∞–∏–º–µ–Ω—å—à–∏—Ö –µ–¥–∏–Ω–∏—Ü–∞—Ö)
            slippage: –ü—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 10%)
            
        Returns:
            Dict —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –º–∞—Ä—à—Ä—É—Ç–µ
            
        Raises:
            Exception: –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö API –∏–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö
        """
        try:
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –∞–¥—Ä–µ—Å–∞ —Ç–æ–∫–µ–Ω–∞
            try:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å Solana
                PublicKey(output_mint)
            except Exception as e:
                logger.error(f"–ù–µ–≤–∞–ª–∏–¥–Ω—ã–π –∞–¥—Ä–µ—Å —Ç–æ–∫–µ–Ω–∞ {output_mint}: {str(e)}")
                raise ValueError(f"–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∞–¥—Ä–µ—Å–∞ —Ç–æ–∫–µ–Ω–∞: {output_mint}")
                
            params = {
                "inputMint": input_mint,
                "outputMint": output_mint,
                "amount": str(amount),
                "slippageBps": str(int(slippage * 100)),
                "platformFeeBps": str(JUPITER_PLATFORM_FEE_BPS),
                "platformFeeAccount": JUPITER_PLATFORM_FEE_ACCOUNT
            }
            
            logger.debug(f"Requesting quote with params: {params}")
            
            async with aiohttp.ClientSession(headers=self.headers) as session:
                async with session.get(self.quote_api_url, params=params) as response:
                    if response.status != 200:
                        error_data = await response.json()
                        error_msg = error_data.get("error", "Unknown error")
                        raise Exception(f"Jupiter API error: {error_msg}")
                    
                    result = await response.json()
                    logger.debug(f"Received quote data: {result}")
                    
                    # –õ–æ–≥–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–º–∏—Å—Å–∏–∏
                    if "platformFee" in result:
                        fee_amount = result["platformFee"]["amount"]
                        logger.info(f"–ü–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω–∞—è –∫–æ–º–∏—Å—Å–∏—è: {fee_amount}")
                    
                    return result
                    
        except ValueError as ve:
            logger.error(f"Validation error: {str(ve)}")
            raise
        except Exception as e:
            logger.error(f"Error getting best route: {str(e)}")
            raise

    async def get_blockhash_with_retry(self, max_retries: int = 3) -> str:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–π blockhash –æ—Ç Solana RPC —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏
        
        Args:
            max_retries: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫
            
        Returns:
            str: –ê–∫—Ç—É–∞–ª—å–Ω—ã–π blockhash
            
        Raises:
            Exception: –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö –ø–æ–ª—É—á–µ–Ω–∏—è blockhash
        """
        for attempt in range(max_retries):
            try:
                logger.info(f"–ü–æ–ø—ã—Ç–∫–∞ {attempt + 1}/{max_retries} –ø–æ–ª—É—á–µ–Ω–∏—è blockhash...")
                response = await self.solana_client.get_latest_blockhash()
                
                # –î–ª—è solders 0.30.2
                if hasattr(response, 'value') and hasattr(response.value, 'blockhash'):
                    recent_blockhash = str(response.value.blockhash)
                    logger.info(f"‚úÖ Blockhash —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω: {recent_blockhash}")
                    return recent_blockhash
                else:
                    raise Exception("‚ùå –û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç RPC")
                
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ blockhash: {str(e)}")
                if attempt < max_retries - 1:
                    await asyncio.sleep(1)
                    continue
                raise Exception(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å blockhash –ø–æ—Å–ª–µ {max_retries} –ø–æ–ø—ã—Ç–æ–∫")

    async def perform_swap(
        self,
        token_out_address: str,
        amount: str,
        user_wallet_address: str,
        user_private_key: str,
        slippage: float = 10.0,
        max_retries: int = 2,
        is_selling: bool = False
    ) -> str:
        """
        –í—ã–ø–æ–ª–Ω—è–µ—Ç —Å–≤–æ–ø —Ç–æ–∫–µ–Ω–æ–≤ —á–µ—Ä–µ–∑ Jupiter API.
        –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ–±–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–±–º–µ–Ω–∞: –ø–æ–∫—É–ø–∫—É –∏ –ø—Ä–æ–¥–∞–∂—É —Ç–æ–∫–µ–Ω–æ–≤.
        
        Args:
            token_out_address: –ê–¥—Ä–µ—Å –≤—ã—Ö–æ–¥–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ / –≤—Ö–æ–¥–Ω–æ–≥–æ –ø—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ
            amount: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è —Å–≤–æ–ø–∞ (–≤ –Ω–∞–∏–º–µ–Ω—å—à–∏—Ö –µ–¥–∏–Ω–∏—Ü–∞—Ö)
            user_wallet_address: –ê–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            user_private_key: –ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ base58
            slippage: –ü—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1%)
            max_retries: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫
            is_selling: True –µ—Å–ª–∏ —ç—Ç–æ –ø—Ä–æ–¥–∞–∂–∞ —Ç–æ–∫–µ–Ω–∞ –∑–∞ SOL (–¢–æ–∫–µ–Ω ‚Üí SOL), 
                        False –µ—Å–ª–∏ —ç—Ç–æ –ø–æ–∫—É–ø–∫–∞ —Ç–æ–∫–µ–Ω–∞ –∑–∞ SOL (SOL ‚Üí –¢–æ–∫–µ–Ω)
            
        Returns:
            str: –ü–æ–¥–ø–∏—Å—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
            
        Raises:
            Exception: –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö API –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–µ–π
        """
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
        if not isinstance(token_out_address, str):
            token_out_address = str(token_out_address)
        if not isinstance(amount, str):
            amount = str(amount)
        if not isinstance(user_wallet_address, str):
            user_wallet_address = str(user_wallet_address)
        if not isinstance(user_private_key, str):
            user_private_key = str(user_private_key)
            
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤—Ö–æ–¥–Ω–æ–π –∏ –≤—ã—Ö–æ–¥–Ω–æ–π —Ç–æ–∫–µ–Ω—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–±–º–µ–Ω–∞
        if is_selling:
            input_mint = token_out_address
            output_mint = "So11111111111111111111111111111111111111112"  # SOL
        else:
            input_mint = "So11111111111111111111111111111111111111112"  # SOL
            output_mint = token_out_address
            
        is_bonk = not is_selling and output_mint == "DezXAZ8z7PnrnRJjz3wXBoRgixCa6xjnB7YaB1pPB263"
        if is_bonk:
            logger.info("ü¶ä –û–±–Ω–∞—Ä—É–∂–µ–Ω BONK —Ç–æ–∫–µ–Ω")
            slippage = 10.0
            
        for attempt in range(max_retries):
            try:
                logger.info(f"–ü–æ–ø—ã—Ç–∫–∞ {attempt + 1}/{max_retries} –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–≤–æ–ø–∞")
                
                # 1. –ü–æ–ª—É—á–∞–µ–º quote
                quote_data = await self._get_quote(
                    input_mint=input_mint,
                    output_mint=output_mint,
                    amount=amount,
                    slippage=slippage
                )
                
                if not quote_data:
                    logger.error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å quote –æ—Ç Jupiter API")
                    if attempt < max_retries - 1:
                        await asyncio.sleep(1)
                        continue
                    raise Exception("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å quote –æ—Ç Jupiter API")
                
                # 2. –í—ã–ø–æ–ª–Ω—è–µ–º —Å–≤–æ–ø
                swap_transaction = await self._get_swap_transaction(
                    user_wallet_address=user_wallet_address,
                    quote_data=quote_data
                )
                
                if not swap_transaction:
                    logger.error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é —Å–≤–æ–ø–∞ –æ—Ç Jupiter API")
                    if attempt < max_retries - 1:
                        await asyncio.sleep(1)
                        continue
                    raise Exception("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é —Å–≤–æ–ø–∞ –æ—Ç Jupiter API")
                
                # 3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
                signature = await self._send_swap_transaction(
                    swap_transaction=swap_transaction,
                    user_private_key=user_private_key
                )
                
                if not signature:
                    logger.error("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é —Å–≤–æ–ø–∞")
                    if attempt < max_retries - 1:
                        await asyncio.sleep(1)
                        continue
                    raise Exception("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é —Å–≤–æ–ø–∞")
                
                # –í—Å–µ –ø—Ä–æ—à–ª–æ —É—Å–ø–µ—à–Ω–æ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º signature
                return signature
                        
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —Å–≤–æ–ø–∞: {str(e)}")
                if attempt < max_retries - 1:
                    await asyncio.sleep(1)
                    continue
                raise
                
    async def _get_quote(self, input_mint: str, output_mint: str, amount: str, slippage: float) -> dict:
        """–ü–æ–ª—É—á–∞–µ—Ç quote –æ—Ç Jupiter API"""
        try:
            async with httpx.AsyncClient(timeout=10.0, headers=self.headers) as client:
                quote_params = {
                    "inputMint": input_mint,
                    "outputMint": output_mint,
                    "amount": amount,
                    "slippageBps": str(int(slippage * 100)),
                    "onlyDirectRoutes": "true",
                    "platformFeeBps": str(JUPITER_PLATFORM_FEE_BPS),
                    "platformFeeAccount": JUPITER_PLATFORM_FEE_ACCOUNT
                }
                
                logger.debug(f"–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ quote —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏: {quote_params}")
                
                quote_response = await client.get(
                    self.quote_api_url,
                    params=quote_params
                )
                
                if quote_response.status_code != 200:
                    error_data = await quote_response.json()
                    error_msg = error_data.get("error", "Unknown error")
                    raise Exception(f"Jupiter Quote API error: {error_msg}")
                
                quote_data = await quote_response.json()
                if "error" in quote_data:
                    raise Exception(f"Jupiter Quote API error: {quote_data['error']}")
                
                # –õ–æ–≥–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–º–∏—Å—Å–∏–∏
                if "platformFee" in quote_data:
                    fee_amount = quote_data["platformFee"]["amount"]
                    logger.info(f"–ü–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω–∞—è –∫–æ–º–∏—Å—Å–∏—è: {fee_amount}")
                
                logger.info(f"–ü–æ–ª—É—á–µ–Ω quote")
                return quote_data
                
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ quote: {str(e)}")
            return None
    
    async def _get_swap_transaction(self, user_wallet_address: str, quote_data: dict) -> str:
        """–ü–æ–ª—É—á–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é —Å–≤–æ–ø–∞ –æ—Ç Jupiter API"""
        try:
            async with httpx.AsyncClient(timeout=10.0, headers=self.headers) as client:
                # –ì–æ—Ç–æ–≤–∏–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–≤–∞–ø
                swap_req = {
                    "userPublicKey": user_wallet_address,  # —Å—Ç—Ä–æ–∫–∞, –Ω–µ —Ñ—É–Ω–∫—Ü–∏—è
                    "wrapUnwrapSOL": True,
                    "quoteResponse": quote_data,
                    "asLegacyTransaction": True,
                    "platformFeeBps": JUPITER_PLATFORM_FEE_BPS,
                    "platformFeeAccount": JUPITER_PLATFORM_FEE_ACCOUNT
                }

                logger.debug("–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ swap")
                
                resp = await client.post(self.swap_api_url, json=swap_req)
                
                # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –æ—Ç–≤–µ—Ç–∞
                if resp.status_code != 200:
                    try:
                        error_data = await resp.json()
                        error_msg = error_data.get("error", "Unknown error")
                    except Exception as json_err:
                        # –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –Ω–µ —è–≤–ª—è–µ—Ç—Å—è JSON, –≤—ã–≤–µ–¥–µ–º –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
                        error_text = await resp.text()
                        logger.error(f"–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç API (–Ω–µ JSON): {error_text[:200]}")
                        error_msg = f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç API: {str(json_err)}"
                    raise Exception(f"Jupiter Swap API error: {error_msg}")
                
                # –ü–æ–ª—É—á–µ–Ω–∏–µ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–∞
                swap_data = await resp.json()
                logger.info("‚úÖ Swap –∑–∞–ø—Ä–æ—Å —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω")
                
                if "error" in swap_data:
                    raise Exception(f"Jupiter Swap API error: {swap_data['error']}")
                
                # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ –æ—Ç–≤–µ—Ç–µ
                tx_b64 = swap_data.get("swapTransaction")
                if not tx_b64 or len(tx_b64) < 100:
                    logger.warning("–ü–æ–ª—É—á–µ–Ω–∞ –ø—É—Å—Ç–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è")
                    return None
                
                return tx_b64
                
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å–≤–æ–ø–∞: {str(e)}")
            return None
    
    async def _send_swap_transaction(self, swap_transaction: str, user_private_key: str) -> str:
        """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é —Å–≤–æ–ø–∞ –≤ —Å–µ—Ç—å Solana"""
        try:
            # –î–µ–∫–æ–¥–∏—Ä—É–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –∏–∑ base64
            try:
                tx_bytes = base64.b64decode(swap_transaction)
                
                # –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
                tx = Transaction.deserialize(tx_bytes)
            except Exception as decode_err:
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: {str(decode_err)}")
                logger.error(f"–ù–∞—á–∞–ª–æ —Å—Ç—Ä–æ–∫–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: {swap_transaction[:50]}")
                raise Exception(f"–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é: {str(decode_err)}")
            
            # –†–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ–º –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á –∏ —Å–æ–∑–¥–∞–µ–º –∫–æ—à–µ–ª–µ–∫
            try:
                # –ü—Ä–æ–±—É–µ–º —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å –∫–ª—é—á, —Ç–∞–∫ –∫–∞–∫ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–Ω –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω
                decrypted_key = decrypt_private_key(user_private_key)
                logger.debug("–ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á —É—Å–ø–µ—à–Ω–æ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω")
            except Exception as decrypt_err:
                # –ï—Å–ª–∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å, –≤–æ–∑–º–æ–∂–Ω–æ –∫–ª—é—á –Ω–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω (—Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç)
                logger.info(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å –∫–ª—é—á, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞–∫ –µ—Å—Ç—å: {str(decrypt_err)}")
                decrypted_key = user_private_key
                
            # –°–æ–∑–¥–∞–µ–º –∫–æ—à–µ–ª–µ–∫ –∏–∑ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞
            private_key_bytes = base58.b58decode(decrypted_key)
            wallet = Keypair.from_secret_key(private_key_bytes)
            
            # –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
            tx.sign(wallet)
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –≤ —Å–µ—Ç—å
            tx_sig = await self.solana_client.send_raw_transaction(
                tx.serialize(),
                opts=TxOpts(
                    skip_preflight=True,
                    preflight_commitment="confirmed",
                    max_retries=3
                )
            )
            
            # –ü–æ–ª—É—á–∞–µ–º signature
            if isinstance(tx_sig, str):
                signature = tx_sig
            else:
                signature = str(tx_sig.value) if hasattr(tx_sig, 'value') else str(tx_sig)
                
            logger.info(f"‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞: {signature}")
            logger.info(f"üí∞ –ö–æ–º–∏—Å—Å–∏—è ({JUPITER_PLATFORM_FEE_BPS/100}%) –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞: {JUPITER_PLATFORM_FEE_ACCOUNT}")
            
            # –ñ–¥–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
            try:
                # –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
                await asyncio.sleep(2)
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
                status = await self.solana_client.get_signature_statuses([signature])
                
                if status and hasattr(status, 'value') and status.value and status.value[0]:
                    tx_status = status.value[0]
                    if hasattr(tx_status, 'err') and tx_status.err:
                        logger.error(f"‚ùå –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π: {tx_status.err}")
                        raise Exception(f"Transaction failed: {tx_status.err}")
                    elif hasattr(tx_status, 'confirmation_status') and str(tx_status.confirmation_status) in ["confirmed", "finalized"]:
                        logger.info(f"‚úÖ Swap confirmed! Transaction: {signature}")
                    else:
                        logger.warning(f"‚ö†Ô∏è –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è")
                else:
                    logger.warning(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: {signature}")
                    
            except Exception as confirm_error:
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: {str(confirm_error)}")
                # –ù–µ –≤—ã–∑—ã–≤–∞–µ–º raise - –ª—É—á—à–µ –≤–µ—Ä–Ω—É—Ç—å —Å–∏–≥–Ω–∞—Ç—É—Ä—É, –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
            
            return signature
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: {str(e)}")
            return None
                    
                                max_retries=3
                            )
                        )
                        
                        # –ü–æ–ª—É—á–∞–µ–º signature
                        if isinstance(tx_sig, str):
                            signature = tx_sig
                        else:
                            signature = str(tx_sig.value)
                            
                        logger.info(f"‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞: {signature}")
                        logger.info(f"üí∞ –ö–æ–º–∏—Å—Å–∏—è ({JUPITER_PLATFORM_FEE_BPS/100}%) –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞: {JUPITER_PLATFORM_FEE_ACCOUNT}")
                        
                        # –ñ–¥–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
                        try:
                            # –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
                            await asyncio.sleep(2)
                            
                            # –ù–∞–ø—Ä—è–º—É—é –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä–æ–∫—É –ø–æ–¥–ø–∏—Å–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
                            status = await self.solana_client.get_signature_statuses([signature])
                            
                            if status and status.value and status.value[0]:
                                tx_status = status.value[0]
                                if tx_status.err:
                                    logger.error(f"‚ùå –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π: {tx_status.err}")
                                    raise Exception(f"Transaction failed: {tx_status.err}")
                                elif str(tx_status.confirmation_status) in ["confirmed", "finalized"]:
                                    logger.info(f"‚úÖ Swap confirmed! Transaction: {signature}")
                                else:
                                    logger.warning(f"‚ö†Ô∏è –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è: {tx_status.confirmation_status}")
                            else:
                                logger.warning(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: {signature}")
                                
                        except Exception as confirm_error:
                            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: {str(confirm_error)}")
                            raise
                        
                        return signature
                        
                    except Exception as e:
                        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: {str(e)}")
                        if attempt < max_retries - 1:
                            await asyncio.sleep(1)
                            continue
                        raise
                        
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —Å–≤–æ–ø–∞: {str(e)}")
                if attempt < max_retries - 1:
                    await asyncio.sleep(1)
                    continue
                raise

    async def execute_swap(
        self, 
        user_pubkey: str, 
        user_privkey: str, 
        route: Dict[str, Any]
    ) -> str:
        """
        –í—ã–ø–æ–ª–Ω—è–µ—Ç —Å–≤–æ–ø —á–µ—Ä–µ–∑ Jupiter API
        
        Args:
            user_pubkey: –ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            user_privkey: –ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ base58
            route: –ú–∞—Ä—à—Ä—É—Ç —Å–≤–æ–ø–∞, –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –∏–∑ get_best_route
            
        Returns:
            str: –°—Å—ã–ª–∫–∞ –Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –≤ Solscan –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
            
        Raises:
            Exception: –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö API –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–µ–π
        """
        try:
            logger.info("–ù–∞—á–∞–ª–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–≤–æ–ø–∞...")
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ route
            output_mint = route.get("outputMint")
            amount = route.get("inAmount")
            
            if not all([output_mint, amount]):
                raise ValueError("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç route: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã")
            
            logger.info(f"–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–≤–æ–ø–∞: output_mint={output_mint}, amount={amount}")
            
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–æ–∫–µ–Ω–∞
            if output_mint == "DezXAZ8z7PnrnRJjz3wXBoRgixCa6xjnB7YaB1pPB263":  # BONK
                # –£–º–µ–Ω—å—à–∞–µ–º –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏–µ –¥–ª—è BONK, —Å–æ—Ö—Ä–∞–Ω—è—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
                bonk_slippage = 10.0
                logger.info(f"–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏–µ –¥–ª—è BONK: {bonk_slippage}%")
            else:
                # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏–µ –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ç–æ–∫–µ–Ω–æ–≤
                bonk_slippage = 1.0
            
            # –í—ã–ø–æ–ª–Ω—è–µ–º —Å–≤–æ–ø —á–µ—Ä–µ–∑ –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é
            signature = await self.perform_swap(
                token_out_address=output_mint,
                amount=str(amount),
                user_wallet_address=user_pubkey,
                user_private_key=user_privkey,
                slippage=bonk_slippage,  # –ò—Å–ø–æ–ª—å–∑—É–µ–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏–µ
                is_selling=False  # –ü–æ–∫—É–ø–∫–∞ —Ç–æ–∫–µ–Ω–∞ –∑–∞ SOL
            )
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º signature –∏–∑ —Å—Ç—Ä–æ–∫–æ–≤–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞
            if isinstance(signature, str):
                if 'Signature(' in signature:
                    tx_signature = signature.split('Signature(')[1].split(')')[0]
                else:
                    tx_signature = signature
            else:
                tx_signature = str(signature)
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
            solscan_url = f"https://solscan.io/tx/{tx_signature}"
            logger.info(f"–°–≤–æ–ø –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ: {solscan_url}")
            
            # –ü—Ä–æ–±—É–µ–º –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
            try:
                # –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
                await asyncio.sleep(2)
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
                status_resp = await self.solana_client.get_signature_statuses([tx_signature])
                if 'result' in status_resp and status_resp['result'] and status_resp['result']['value']:
                    confirmation_status = status_resp['result']['value'][0]
                    if confirmation_status:
                        logger.info(f"–°—Ç–∞—Ç—É—Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: {confirmation_status}")
                        if confirmation_status.get('err'):
                            logger.error(f"üö® –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π: {confirmation_status.get('err')}")
                        elif confirmation_status.get('confirmationStatus') in ['finalized', 'confirmed']:
                            logger.info(f"‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞! ID: {tx_signature}")
                        else:
                            logger.warning(f"‚è≥ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è: {confirmation_status.get('confirmationStatus')}")
                    else:
                        logger.warning(f"‚ö†Ô∏è –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –±–ª–æ–∫—á–µ–π–Ω–µ. –í–æ–∑–º–æ–∂–Ω–æ, –µ—â–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∏–ª–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞.")
            except Exception as status_error:
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞—Ç—É—Å–∞ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: {status_error}")
            
            return solscan_url
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ execute_swap: {str(e)}")
            
            # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –¥–ª—è –ª—É—á—à–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
            error_message = str(e)
            if "Custom: 1" in error_message:
                return "‚ùå –û—à–∏–±–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å –∏–ª–∏ —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∞—è —Å—É–º–º–∞ –æ–±–º–µ–Ω–∞"
            elif "Custom: 6000" in error_message:
                return "‚ùå –û—à–∏–±–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: –°–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–æ–µ –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏–µ"
            elif "0x1771" in error_message:
                return "‚ùå –û—à–∏–±–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–±–º–µ–Ω–∞"
            
            return f"‚ùå –û—à–∏–±–∫–∞: {error_message}"

    async def get_token_decimals(self, token_address: str) -> int:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ decimals –¥–ª—è —Ç–æ–∫–µ–Ω–∞
        
        Args:
            token_address: –ê–¥—Ä–µ—Å —Ç–æ–∫–µ–Ω–∞
            
        Returns:
            int: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ decimals —Ç–æ–∫–µ–Ω–∞
        """
        try:
            # –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –∫ RPC
            payload = {
                "jsonrpc": "2.0",
                "id": 1,
                "method": "getTokenSupply",
                "params": [token_address]
            }
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ RPC
            async with aiohttp.ClientSession() as session:
                async with session.post(SOLANA_RPC_URL, json=payload) as response:
                    if response.status != 200:
                        logger.error(f"–û—à–∏–±–∫–∞ RPC –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ decimals: {response.status}")
                        return 9  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                        
                    data = await response.json()
                    if "error" in data:
                        logger.error(f"–û—à–∏–±–∫–∞ RPC –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ decimals: {data['error']}")
                        return 9
                        
                    decimals = data.get("result", {}).get("value", {}).get("decimals", 9)
                    logger.info(f"Decimals —Ç–æ–∫–µ–Ω–∞ {token_address}: {decimals}")
                    return decimals
                    
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ decimals —Ç–æ–∫–µ–Ω–∞: {str(e)}")
            return 9  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

    async def execute_sell(
        self, 
        user_pubkey: str, 
        user_privkey: str, 
        token_address: str,
        amount: Union[int, float, str]
    ) -> str:
        """
        –í—ã–ø–æ–ª–Ω—è–µ—Ç –ø—Ä–æ–¥–∞–∂—É —Ç–æ–∫–µ–Ω–∞ –∑–∞ SOL —á–µ—Ä–µ–∑ Jupiter API
        
        Args:
            user_pubkey: –ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π base58)
            user_privkey: –ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ base58
            token_address: –ê–¥—Ä–µ—Å —Ç–æ–∫–µ–Ω–∞ –∏–ª–∏ –µ–≥–æ —Å–∏–º–≤–æ–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'RAY' –∏–ª–∏ 'Orca')
            amount: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏ (–º–æ–∂–µ—Ç –±—ã—Ç—å int, float –∏–ª–∏ str)
            
        Returns:
            str: –°—Å—ã–ª–∫–∞ –Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –≤ Solscan –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
        """
        try:
            # –õ–æ–≥–∏—Ä—É–µ–º –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º user_pubkey
            logger.debug(f"user_pubkey={user_pubkey} ({type(user_pubkey)})")
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ —Å—Ç—Ä–æ–∫—É –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            if not isinstance(user_pubkey, str):
                try:
                    user_pubkey = str(user_pubkey)
                    logger.warning(f"user_pubkey –±—ã–ª –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –≤ —Å—Ç—Ä–æ–∫—É –∏–∑ {type(user_pubkey)}")
                except Exception as e:
                    error_msg = f"–ù–µ —É–¥–∞–ª–æ—Å—å –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å user_pubkey –≤ —Å—Ç—Ä–æ–∫—É: {str(e)}"
                    logger.error(error_msg)
                    return f"‚ùå –û—à–∏–±–∫–∞: {error_msg}"
            
            # –û—á–∏—â–∞–µ–º –æ—Ç –ø—Ä–æ–±–µ–ª–æ–≤
            user_pubkey = user_pubkey.strip()
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É
            if len(user_pubkey) < 32:
                error_msg = f"–°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –∞–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞: {user_pubkey}"
                logger.error(error_msg)
                return f"‚ùå –û—à–∏–±–∫–∞: {error_msg}"
                
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç base58
            try:
                decoded = base58.b58decode(user_pubkey)
                if len(decoded) != 32:
                    error_msg = f"–ù–µ–≤–µ—Ä–Ω–∞—è –¥–ª–∏–Ω–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∞–¥—Ä–µ—Å–∞ –∫–æ—à–µ–ª—å–∫–∞: {len(decoded)} –±–∞–π—Ç (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 32)"
                    logger.error(error_msg)
                    return f"‚ùå –û—à–∏–±–∫–∞: {error_msg}"
            except Exception as e:
                error_msg = f"–ê–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞ –Ω–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ base58: {str(e)}"
                logger.error(error_msg)
                return f"‚ùå –û—à–∏–±–∫–∞: {error_msg}"
                
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ PublicKey
            try:
                wallet_pubkey = PublicKey(user_pubkey)
                logger.info(f"‚úÖ –ê–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞ –≤–∞–ª–∏–¥–µ–Ω: {wallet_pubkey}")
            except Exception as e:
                error_msg = f"–ù–µ–≤–∞–ª–∏–¥–Ω—ã–π –∞–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞: {str(e)}"
                logger.error(error_msg)
                return f"‚ùå –û—à–∏–±–∫–∞: {error_msg}"

            logger.info(f"–ù–∞—á–∞–ª–æ –ø—Ä–æ–¥–∞–∂–∏ —Ç–æ–∫–µ–Ω–∞ {token_address}")
            
            # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Å–∏–º–≤–æ–ª —Ç–æ–∫–µ–Ω–∞ –≤ –∞–¥—Ä–µ—Å, –µ—Å–ª–∏ —ç—Ç–æ —Å–∏–º–≤–æ–ª
            original_input = token_address
            if token_address.upper() in SOLANA_TOKEN_ADDRESSES:
                token_address = SOLANA_TOKEN_ADDRESSES[token_address.upper()]
                logger.info(f"–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω —Å–∏–º–≤–æ–ª —Ç–æ–∫–µ–Ω–∞ {original_input} –≤ –∞–¥—Ä–µ—Å: {token_address}")
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∞–¥—Ä–µ—Å–∞ —Ç–æ–∫–µ–Ω–∞
            try:
                token_pubkey = PublicKey(token_address)
            except Exception as e:
                error_msg = f"–ù–µ–≤–∞–ª–∏–¥–Ω—ã–π –∞–¥—Ä–µ—Å —Ç–æ–∫–µ–Ω–∞ {original_input}: {str(e)}"
                logger.error(error_msg)
                return f"‚ùå –û—à–∏–±–∫–∞: {error_msg}"
            
            # –ü–æ–ª—É—á–∞–µ–º –±–∞–ª–∞–Ω—Å —Ç–æ–∫–µ–Ω–∞ –∏ –µ–≥–æ decimals
            token_balance_raw, token_decimals = await self.get_token_balance(str(wallet_pubkey), str(token_pubkey))
            if not token_balance_raw:
                return f"‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –±–∞–ª–∞–Ω—Å —Ç–æ–∫–µ–Ω–∞ {original_input}"
                
            logger.info(f"Decimals —Ç–æ–∫–µ–Ω–∞ {original_input} ({token_pubkey}): {token_decimals}")
            
            # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º amount –≤ raw_amount
            try:
                # –ï—Å–ª–∏ amount —É–∂–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ –∫–∞–∫ –µ—Å—Ç—å
                if isinstance(amount, int):
                    raw_amount = amount
                # –ï—Å–ª–∏ amount —Å—Ç—Ä–æ–∫–∞, –ø—Ä–æ–±—É–µ–º –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –≤ float
                elif isinstance(amount, str):
                    amount_float = float(amount)
                    raw_amount = int(amount_float * (10 ** token_decimals))
                # –ï—Å–ª–∏ amount float, —É–º–Ω–æ–∂–∞–µ–º –Ω–∞ 10^decimals
                elif isinstance(amount, float):
                    raw_amount = int(amount * (10 ** token_decimals))
                else:
                    raise ValueError(f"–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø amount: {type(amount)}")
                    
                logger.info(f"–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π amount: {raw_amount} (–∏–∑ {amount} * 10^{token_decimals})")
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ raw_amount –Ω–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π
                if raw_amount > 10**18:  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Ä–∞–∑—É–º–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                    raise ValueError(f"–°—É–º–º–∞ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∞—è: {raw_amount}")
                    
            except (ValueError, TypeError) as e:
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ amount: {str(e)}")
                return f"‚ùå –û—à–∏–±–∫–∞: –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å—É–º–º—ã: {str(e)}"
            
            # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –±–∞–ª–∞–Ω—Å –≤ —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
            token_balance = token_balance_raw / (10 ** token_decimals)
            logger.info(f"–ë–∞–ª–∞–Ω—Å —Ç–æ–∫–µ–Ω–∞ {original_input}: {token_balance:.6f} (raw: {token_balance_raw})")
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–∞–ø—Ä–æ—à–µ–Ω–Ω–∞—è —Å—É–º–º–∞ –Ω–µ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –±–∞–ª–∞–Ω—Å
            if raw_amount > token_balance_raw:
                # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –æ–±–∞ –∑–Ω–∞—á–µ–Ω–∏—è –≤ —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è
                human_balance = token_balance_raw / (10 ** token_decimals)
                human_amount = raw_amount / (10 ** token_decimals)
                return f"‚ùå –û—à–∏–±–∫–∞: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–∫–µ–Ω–æ–≤. –ë–∞–ª–∞–Ω—Å: {human_balance:.6f}, –ó–∞–ø—Ä–æ—à–µ–Ω–æ: {human_amount:.6f}"
            
            # –û–∫—Ä—É–≥–ª—è–µ–º —Å—É–º–º—É –≤–Ω–∏–∑ –¥–æ –¥–æ–ø—É—Å—Ç–∏–º–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
            # –û—Å—Ç–∞–≤–ª—è–µ–º 0.01 —Ç–æ–∫–µ–Ω–∞ –Ω–∞ –∫–æ–º–∏—Å—Å–∏—é
            min_balance = int(0.01 * (10 ** token_decimals))
            if token_balance_raw - raw_amount < min_balance:
                raw_amount = token_balance_raw - min_balance
                human_amount = raw_amount / (10 ** token_decimals)
                logger.info(f"–°—É–º–º–∞ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ –¥–æ: {human_amount:.6f} (–æ—Å—Ç–∞–≤–ª–µ–Ω–æ {min_balance/(10**token_decimals):.6f} –Ω–∞ –∫–æ–º–∏—Å—Å–∏—é)")
            
            # SOL –≤—Å–µ–≥–¥–∞ –±—É–¥–µ—Ç –≤—ã—Ö–æ–¥–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º –ø—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ
            output_mint = "So11111111111111111111111111111111111111112"  # SOL
            
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–∞–∑–æ–≤–æ–µ –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏–µ
            slippage = 1.0  # –£–º–µ–Ω—å—à–∞–µ–º –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏–µ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è
            
            # –î–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤ —Å –Ω–∏–∑–∫–æ–π –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å—é —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏–µ
            if token_address not in ["EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v", 
                                     "Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB"]:
                slippage = 3.0  # –ë–æ–ª–µ–µ —Ä–∞–∑—É–º–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ç–æ–∫–µ–Ω–æ–≤
            
            # –ü–æ–ª—É—á–∞–µ–º –º–∞—Ä—à—Ä—É—Ç –∏ —Å—Ä–∞–∑—É –≤—ã–ø–æ–ª–Ω—è–µ–º —Å–≤–æ–ø
            try:
                # –ü–æ–ª—É—á–∞–µ–º –º–∞—Ä—à—Ä—É—Ç –¥–ª—è —Å–≤–æ–ø–∞
                route = await self.get_best_route(
                    input_mint=str(token_address),  # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞
                    output_mint=output_mint,
                    amount=str(raw_amount),  # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞
                    slippage=slippage
                )
            
                if not route:
                    return f"‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –º–∞—Ä—à—Ä—É—Ç –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏ —Ç–æ–∫–µ–Ω–∞ {original_input}"
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ routePlan
                if 'routePlan' not in route or not route.get('routePlan'):
                    logger.error("‚ùå –û—à–∏–±–∫–∞: routePlan –ø—É—Å—Ç–æ–π –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç")
                    return f"‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –º–∞—Ä—à—Ä—É—Ç –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏ —Ç–æ–∫–µ–Ω–∞ {original_input}"
                
                # –°—Ä–∞–∑—É –≤—ã–ø–æ–ª–Ω—è–µ–º —Å–≤–æ–ø
                signature = await self.perform_swap(
                    token_out_address=str(token_address),  # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞
                    amount=str(raw_amount),  # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞
                    user_wallet_address=str(user_pubkey),  # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞
                    user_private_key=str(user_privkey),  # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞
                    slippage=slippage,
                    is_selling=True
                )
                
                # –ò–∑–≤–ª–µ–∫–∞–µ–º signature –∏–∑ —Å—Ç—Ä–æ–∫–æ–≤–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞
                if not signature:
                    logger.error("‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å signature —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏")
                    return "‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å signature —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏"
                
                # –§–æ—Ä–º–∏—Ä—É–µ–º –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
                if isinstance(signature, str):
                    # –ï—Å–ª–∏ signature —É–∂–µ —Å—Ç—Ä–æ–∫–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞–∫ –µ—Å—Ç—å
                    tx_signature = signature
                else:
                    try:
                        # –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø—Ä–∏–≤–µ–¥–µ–Ω–∏–µ –∫ —Å—Ç—Ä–æ–∫–µ
                        tx_signature = str(signature)
                        # –ï—Å–ª–∏ —ç—Ç–æ –æ–±—ä–µ–∫—Ç Signature, –∏–∑–≤–ª–µ–∫–∞–µ–º —Å—Ç—Ä–æ–∫–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ
                        if 'Signature(' in tx_signature:
                            tx_signature = tx_signature.split('Signature(')[1].split(')')[0]
                    except Exception as e:
                        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ signature: {str(e)}")
                        return "‚ùå –û—à–∏–±–∫–∞: –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç signature —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏"
                    
                solscan_url = f"https://solscan.io/tx/{tx_signature}"
                logger.info(f"–ü—Ä–æ–¥–∞–∂–∞ —Ç–æ–∫–µ–Ω–∞ {original_input} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞: {solscan_url}")
                return solscan_url
                
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ —Ç–æ–∫–µ–Ω–∞ {original_input}: {str(e)}")
                error_msg = str(e)
                
                # –ë–æ–ª–µ–µ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
                if "insufficient funds" in error_msg.lower() or "not enough lamports" in error_msg.lower():
                    return "‚ùå –û—à–∏–±–∫–∞: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏"
                elif "invalid token" in error_msg.lower() or "invalid mint" in error_msg.lower():
                    return "‚ùå –û—à–∏–±–∫–∞: –ù–µ–≤–µ—Ä–Ω—ã–π –∞–¥—Ä–µ—Å —Ç–æ–∫–µ–Ω–∞"
                elif "slippage exceeded" in error_msg.lower():
                    return "‚ùå –û—à–∏–±–∫–∞: –ü—Ä–µ–≤—ã—à–µ–Ω –ø–æ—Ä–æ–≥ –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑"
                elif "liquidity" in error_msg.lower():
                    return "‚ùå –û—à–∏–±–∫–∞: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É–º–µ–Ω—å—à–∏—Ç—å —Å—É–º–º—É"
                elif "Custom: 1" in error_msg:
                    return "‚ùå –û—à–∏–±–∫–∞: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å –≤ –ø—É–ª–µ –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏ —Ç–æ–∫–µ–Ω–∞"
                
                return f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ —Ç–æ–∫–µ–Ω–∞ {original_input}: {error_msg}"
                
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ execute_sell: {str(e)}")
            return f"‚ùå –û—à–∏–±–∫–∞: {str(e)}"
            
    async def get_token_balance(self, wallet_address: str, token_address: str) -> tuple[int, int]:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –±–∞–ª–∞–Ω—Å —Ç–æ–∫–µ–Ω–∞ –∏ –µ–≥–æ decimals –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –∫–æ—à–µ–ª—å–∫–∞
        
        Args:
            wallet_address: –ê–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞
            token_address: –ê–¥—Ä–µ—Å —Ç–æ–∫–µ–Ω–∞ –∏–ª–∏ –µ–≥–æ —Å–∏–º–≤–æ–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'RAY' –∏–ª–∏ 'Orca')
            
        Returns:
            tuple[int, int]: (–±–∞–ª–∞–Ω—Å —Ç–æ–∫–µ–Ω–∞ –≤ –Ω–∞–∏–º–µ–Ω—å—à–∏—Ö –µ–¥–∏–Ω–∏—Ü–∞—Ö, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ decimals)
        """
        try:
            original_input = token_address
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–µ—Ä–µ–¥–∞–Ω –ª–∏ —Å–∏–º–≤–æ–ª —Ç–æ–∫–µ–Ω–∞ –≤–º–µ—Å—Ç–æ –∞–¥—Ä–µ—Å–∞
            if token_address.upper() in SOLANA_TOKEN_ADDRESSES:
                token_address = SOLANA_TOKEN_ADDRESSES[token_address.upper()]
                logger.info(f"–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω —Å–∏–º–≤–æ–ª —Ç–æ–∫–µ–Ω–∞ {original_input} –≤ –∞–¥—Ä–µ—Å: {token_address}")

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∞–¥—Ä–µ—Å–æ–≤
            try:
                # –û—á–∏—â–∞–µ–º –∞–¥—Ä–µ—Å–∞ –æ—Ç –≤–æ–∑–º–æ–∂–Ω—ã—Ö —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–æ–≤
                wallet_address = wallet_address.strip()
                token_address = token_address.strip()
                
                # –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç—ã PublicKey –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏
                try:
                    token_pubkey = PublicKey(token_address)
                except Exception as e:
                    logger.error(f"–ù–µ–≤–∞–ª–∏–¥–Ω—ã–π –∞–¥—Ä–µ—Å —Ç–æ–∫–µ–Ω–∞ {original_input}: {str(e)}")
                    return 0, 9
                    
                try:
                    wallet_pubkey = PublicKey(wallet_address)
                except Exception as e:
                    logger.error(f"–ù–µ–≤–∞–ª–∏–¥–Ω—ã–π –∞–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞: {str(e)}")
                    return 0, 9
                    
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∞–¥—Ä–µ—Å–æ–≤: {str(e)}")
                return 0, 9

            # –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –∫ RPC –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è decimals
            decimals_payload = {
                "jsonrpc": "2.0",
                "id": "1",
                "method": "getTokenSupply",
                "params": [str(token_pubkey)]
            }
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –∫ RPC –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
            balance_payload = {
                "jsonrpc": "2.0",
                "id": "2",
                "method": "getTokenAccountsByOwner",
                "params": [
                    str(wallet_pubkey),
                    {
                        "mint": str(token_pubkey)
                    },
                    {
                        "encoding": "jsonParsed"
                    }
                ]
            }
            
            logger.info(f"–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è —Ç–æ–∫–µ–Ω–∞ {original_input} ({token_address})")
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å—ã –∫ RPC
            async with aiohttp.ClientSession() as session:
                # –ü–æ–ª—É—á–∞–µ–º decimals
                async with session.post(SOLANA_RPC_URL, json=decimals_payload) as response:
                    if response.status != 200:
                        logger.error(f"–û—à–∏–±–∫–∞ RPC –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ decimals: {response.status}")
                        return 0, 9
                        
                    decimals_data = await response.json()
                    if "error" in decimals_data:
                        logger.error(f"–û—à–∏–±–∫–∞ RPC –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ decimals: {decimals_data['error']}")
                        return 0, 9
                        
                    decimals = decimals_data.get("result", {}).get("value", {}).get("decimals", 9)
                    logger.info(f"Decimals —Ç–æ–∫–µ–Ω–∞ {original_input}: {decimals}")
                
                # –ü–æ–ª—É—á–∞–µ–º –±–∞–ª–∞–Ω—Å
                async with session.post(SOLANA_RPC_URL, json=balance_payload) as response:
                    if response.status != 200:
                        logger.error(f"–û—à–∏–±–∫–∞ RPC –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞: {response.status}")
                        return 0, decimals
                        
                    data = await response.json()
                    if "error" in data:
                        logger.error(f"–û—à–∏–±–∫–∞ RPC –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞: {data['error']}")
                        return 0, decimals
                        
                    value = data.get("result", {}).get("value", [])
                    if not value:
                        logger.warning(f"–¢–æ–∫–µ–Ω-–∞–∫–∫–∞—É–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è {original_input}")
                        return 0, decimals
                        
                    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç–∞
                    try:
                        account_data = value[0]["account"]["data"]
                        
                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö
                        if isinstance(account_data, str):
                            # –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –≤ –≤–∏–¥–µ —Å—Ç—Ä–æ–∫–∏ (–≤–æ–∑–º–æ–∂–Ω–æ base64), –ª–æ–≥–∏—Ä—É–µ–º –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º 0
                            logger.warning(f"–î–∞–Ω–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è {original_input}")
                            return 0, decimals
                        elif isinstance(account_data, dict):
                            # –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ jsonParsed
                            parsed_data = account_data.get("parsed", {})
                            if not parsed_data or "info" not in parsed_data:
                                logger.warning(f"–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–∞ –¥–ª—è {original_input}")
                                return 0, decimals
                                
                            token_info = parsed_data["info"]
                            if "tokenAmount" not in token_info:
                                logger.warning(f"–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –±–∞–ª–∞–Ω—Å–∞ –¥–ª—è {original_input}")
                                return 0, decimals
                                
                            balance = int(token_info["tokenAmount"]["amount"])
                            logger.info(f"–ë–∞–ª–∞–Ω—Å —Ç–æ–∫–µ–Ω–∞ {original_input}: {balance}")
                            return balance, decimals
                        else:
                            logger.warning(f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–∞ –¥–ª—è {original_input}")
                            return 0, decimals
                    except (IndexError, KeyError) as e:
                        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–∞: {str(e)}")
                        return 0, decimals
                    
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞ —Ç–æ–∫–µ–Ω–∞ {original_input}: {str(e)}")
            return 0, 9  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º 0 –∫–∞–∫ –±–∞–ª–∞–Ω—Å –∏ 9 –∫–∞–∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ decimals 